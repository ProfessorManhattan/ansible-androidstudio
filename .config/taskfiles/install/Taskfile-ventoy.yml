---
version: '3'

vars:
  VENTOY_CONFIG_URL: https://gitlab.com/megabyte-labs/common/shared/-/raw/master/local/ventoy.json
  VENTOY_USB_PATH: /run/media/user/Ventoy

tasks:
  config:
    cmds:
      - curl -sSL '{{.VENTOY_CONFIG_URL}}' > '{{.VENTOY_USB_PATH}}/ventoy/ventoy.json'

  download:
    deps:
      - :install:software:axel
    cmds:
      - task: config
      - |
        jq -c '.distros[]' '{{.VENTOY_USB_PATH}}/ventoy/ventoy.json' | while read VENTOY_OS; do
          VENTORY_URL="$(jq -r -n '$in.url' --argjson in "$VENTOY_OS")"
          VENTORY_URL_AXEL="$(jq -r -n '$in.url' --argjson in "$VENTOY_OS")"
          VENTOY_MD5="$(jq -r -n '$in.md5' --argjson in "$VENTOY_OS")"
          axel "$VENTOY_URL"
        done

  download:os:
    
    cmds:
      - wget {{.OS_URL}} -P /run/media/user/Ventoy
    preconditions:
      - sh: test -d /run/media/user/Ventoy
        msg: The `/run/media/user/Ventoy` mounted USB directory must be available!

  theme:
    cmds:
      - git clone https://github.com/ProfessorManhattan/distro-grub-themes.git /tmp/distro-grub-themes
      - mkdir -p /run/media/user/Ventoy/ventoy/theme
      - cp -rf /tmp/distro-grub-themes/customize/ventoy /run/media/user/Ventoy/ventoy/theme/ventoy
    preconditions:
      - sh: test -d /run/media/user/Ventoy
        msg: The `/run/media/user/Ventoy` mounted USB directory must be available!
