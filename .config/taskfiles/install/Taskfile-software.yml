---
version: '3'

tasks:
  brew:
    deps:
      - common
    run: once
    cmds:
      - task: brew:{{OS}}
    status:
      - type brew &> /dev/null || [[ "${container:=}" == "docker" ]]

  brew:cask:
    deps:
      - brew
    run: when_changed
    cmds:
      - brew install --cask {{.CASK}}
    status:
      - type {{.CASK}} &> /dev/null || [[ "${container:=}" == "docker" ]]

  brew:darwin:
    cmds:
      - |
        if [ -f "~/.local/homebrew/bin/brew" ] && ! type brew &> /dev/null; then
          eval "$(~/.local/homebrew/bin/brew shellenv)"
        elif ! type brew &> /dev/null; then
          rm -rf ~/.local/homebrew
          mkdir -p ~/.local/homebrew
          git clone https://github.com/Homebrew/brew ~/.local/homebrew
          eval "$(~/.local/homebrew/bin/brew shellenv)"
          brew update --force --quiet
          chmod -R go-w "$(brew --prefix)/share/zsh"
        fi

  brew:formulae:
    deps:
      - brew
    run: when_changed
    cmds:
      - brew install {{.FORMULAE}}
    status:
      - type {{.FORMULAE}} &> /dev/null || [[ "${container:=}" == "docker" ]]

  brew:linux:
    run: once
    cmds:
      - |
        function ensureSource() {
          if ! (cat "$1" | grep "/bin/brew shellenv" &> /dev/null); then
            echo "eval \"\$($(brew --prefix)/bin/brew shellenv)\"" >> "$1"
          fi
        }
        if [ -f "~/.local/homebrew/bin/brew" ] && ! type brew &> /dev/null; then
          eval "$(~/.local/homebrew/bin/brew shellenv)"
          ensureSource "~/.bash_profile"
          ensureSource "~/.profile"
        elif ! type brew &> /dev/null; then
          rm -rf ~/.local/homebrew
          mkdir -p ~/.local/homebrew
          git clone https://github.com/Homebrew/brew ~/.local/homebrew
          eval "$(~/.local/homebrew/bin/brew shellenv)"
          brew update --force --quiet
          ensureSource "~/.bash_profile"
          ensureSource "~/.profile"
        fi

  brew:windows:
    cmds:
      - task: common:windows

  common:
    run: once
    cmds:
      - task: common:{{OS}}

  common:darwin:
    interactive: true
    cmds:
      - xcode-select --install
    status:
      - xcode-select -p 2&>1 /dev/null

  common:linux:
    vars:
      LINUX_FAMILY:
        sh: |
          if [ -f "/etc/debian_version" ]; then
            echo "debian"
          elif [ -f "/etc/redhat-release" ]; then
            echo "redhat"
          else
            echo "unknown"
          fi
    cmds:
      - task: common:linux:{{.LINUX_FAMILY}}

  common:linux:debian:
    interactive: true
    cmds:
      - |
        sudo apt-get update
        sudo apt-get install build-essential curl file git procps
    status:
      - type curl &> /dev/null || [[ "${container:=}" == "docker" ]]
      - type git &> /dev/null || [[ "${container:=}" == "docker" ]]
      - dpkg-query -l build-essential &> /dev/null || [[ "${container:=}" == "docker" ]]
      - dpkg-query -l file &> /dev/null || [[ "${container:=}" == "docker" ]]
      - dpkg-query -l procps &> /dev/null || [[ "${container:=}" == "docker" ]]

  common:linux:redhat:
    interactive: true
    cmds:
      - |
        sudo yum groupinstall 'Development Tools'
        sudo yum install curl file git procps-ng
        if [ -f '/etc/os-release' ]; then
          source /etc/os-release
          if [ "$ID" == 'fedora' ] && [ "$VERSION_ID" -gt "29" ]; then
            sudo yum install libxcrypt-compat
          fi
        fi
    status:
      - type curl &> /dev/null || [[ "${container:=}" == "docker" ]]
      - type git &> /dev/null || [[ "${container:=}" == "docker" ]]
      - ldconfig -p | grep file || [[ "${container:=}" == "docker" ]]
      - ldconfig -p | grep procps-ng || [[ "${container:=}" == "docker" ]]

  common:linux:unknown:
    cmds:
      - true warn 'You are using an operating system that we do not directly support. Please make sure
        the equivalent of `build-essential`, `curl`, `file`, `git`, and `procps` are installed.'

  common:windows:
    cmds:
      - true error "Windows is not supported. Try using a Windows WSL environment."
      - exit 1

  docker:
    run: once
    cmds:
      - task: docker:{{OS}}

  docker:darwin:
    run: once
    cmds:
      - task: brew:cask
        vars:
          CASK: docker

  docker:linux:
    run: once
    cmds:
      - task: brew:formulae
        vars:
          FORMULAE: docker

  docker:windows:
    cmds:
      - task: common:windows

  dockle:
    run: once
    cmds:
      - task: brew:formulae
        vars:
          FORMULAE: goodwithtech/r/dockle

  exiftool:
    run: once
    cmds:
      - task: brew:formulae
        vars:
          FORMULAE: exiftool

  gh:
    run: once
    cmds:
      - task: brew:formulae
        vars:
          FORMULAE: gh

  git:
    deps:
      - common
    run: once

  gitleaks:
    run: once
    cmds:
      - task: brew:formulae
        vars:
          FORMULAE: gitleaks

  glab:
    run: once
    cmds:
      - task: brew:formulae
        vars:
          FORMULAE: glab

  jq:
    run: once
    cmds:
      - task: brew:formulae
        vars:
          FORMULAE: jq

  node:
    run: once
    cmds:
      - task: brew:formulae
        vars:
          FORMULAE: node

  poetry:
    run: once
    cmds:
      - task: brew:formulae
        vars:
          FORMULAE: poetry

  python:
    run: once
    cmds:
      - task: brew:formulae
        vars:
          FORMULAE: python

  rsync:
    run: once
    cmds:
      - task: brew:formulae
        vars:
          FORMULAE: rsync

  sshpass:
    run: once
    cmds:
      - task: brew:formulae
        vars:
          FORMULAE: hudochenkov/sshpass/sshpass

  tokei:
    run: once
    cmds:
      - task: brew:formulae
        vars:
          FORMULAE: tokei

  trivy:
    run: once
    cmds:
      - task: brew:formulae
        vars:
          FORMULAE: aquasecurity/trivy/trivy

  vagrant:
    run: once
    cmds:
      - task: brew:cask
        vars:
          CASK: vagrant

  virtualbox:
    run: once
    cmds:
      - task: brew:cask
        vars:
          CASK: virtualbox

  yq:
    run: once
    cmds:
      - task: brew:formulae
        vars:
          FORMULAE: yq
