"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("regexpp"),t=require("refa");function r(e,t){throw new Error(t||e)}exports.Chars=void 0,function(e){const r=t.CharSet.empty(65535),n=t.CharSet.empty(1114111);e.empty=function(e){return e.unicode?n:r};const a=t.CharSet.all(65535),s=t.CharSet.all(1114111);e.all=function(e){return e.unicode?s:a};const o=t.JS.createCharSet([{kind:"any"}],{unicode:!1}).negate(),i=t.JS.createCharSet([{kind:"any"}],{unicode:!0}).negate();e.lineTerminator=function(e){return e.unicode?i:o};const c=t.JS.createCharSet([{kind:"word",negate:!1}],{unicode:!1}),u=t.JS.createCharSet([{kind:"word",negate:!1}],{unicode:!0,ignoreCase:!1}),h=t.JS.createCharSet([{kind:"word",negate:!1}],{unicode:!0,ignoreCase:!0});e.word=function(e){return e.unicode?e.ignoreCase?h:u:c};const l=t.JS.createCharSet([{kind:"digit",negate:!1}],{unicode:!1}),p=t.JS.createCharSet([{kind:"digit",negate:!1}],{unicode:!0});e.digit=function(e){return e.unicode?p:l};const f=t.JS.createCharSet([{kind:"space",negate:!1}],{unicode:!1}),m=t.JS.createCharSet([{kind:"space",negate:!1}],{unicode:!0});e.space=function(e){return e.unicode?m:f}}(exports.Chars||(exports.Chars={}));const n=Array.isArray;class a{constructor(e){this._exactChars=e,this._inexactChars=e}get char(){return this._exactChars.union(this._inexactChars)}get exact(){return this._exactChars.isSupersetOf(this._inexactChars)}add(e){e.exact?this._exactChars=this._exactChars.union(e.char):this._inexactChars=this._inexactChars.union(e.char)}static fromFlags(e){return new a(exports.Chars.empty(e))}static fromMaximum(e){return new a(t.CharSet.empty(e))}}function s(e,t){const r=e.char.intersect(t.char);return{char:r,exact:e.exact&&t.exact||r.isEmpty}}function o(e,t){return n(e)?e.every(t):t(e)}function i(e,t){return n(e)?e.some(t):t(e)}function c(e){return o(e,u)}function u(e){switch(e.type){case"Alternative":return e.elements.every(u);case"Assertion":return!0;case"Character":case"CharacterClass":case"CharacterSet":return!1;case"Quantifier":return 0===e.max||u(e.element);case"Backreference":return v(e);case"CapturingGroup":case"Group":return e.alternatives.length>0&&e.alternatives.every(u);default:throw r(e)}}function h(e,t){return function e(n){switch(n.type){case"Alternative":return n.elements.every(e);case"Assertion":return!0;case"Backreference":return f(n,t);case"Character":case"CharacterClass":case"CharacterSet":return!1;case"CapturingGroup":case"Group":return n.alternatives.some(e);case"Quantifier":return 0===n.min||e(n.element);default:throw r(n)}}(e)}function l(e){switch(e.type){case"Alternative":return e.elements.every(l);case"Assertion":return!1;case"Backreference":return v(e);case"Character":case"CharacterClass":case"CharacterSet":return!1;case"CapturingGroup":case"Group":return e.alternatives.length>0&&e.alternatives.every(l);case"Quantifier":return 0===e.max||l(e.element);default:throw r(e)}}function p(e){return function t(n){switch(n.type){case"Alternative":return n.elements.every(t);case"Assertion":return!1;case"Backreference":return f(n,e);case"Character":case"CharacterClass":case"CharacterSet":return!1;case"CapturingGroup":case"Group":return n.alternatives.some(t);case"Quantifier":return 0===n.min||t(n.element);default:throw r(n)}}(e)}function f(e,t){return!!v(e)||!!m(e.resolved,(e=>e===t))&&(!w(e)||h(e.resolved,t))}function m(e,t){return"function"==typeof t?function(e,t){let r=e.parent;for(;r;){if(t(r))return!0;r=r.parent}return!1}(e,t):function(e,t){let r=e.parent;for(;r;){if(r===t)return!0;r=r.parent}return!1}(e,t)}function d(e,t,r){return"function"==typeof t?C(e,t,r):r?C(e,(e=>e===t),r):e===t||m(t,e)}function C(e,t,r){if(t(e))return!0;if(r&&!r(e))return!1;switch(e.type){case"Alternative":return e.elements.some((e=>C(e,t,r)));case"Assertion":return("lookahead"===e.kind||"lookbehind"===e.kind)&&e.alternatives.some((e=>C(e,t,r)));case"CapturingGroup":case"Group":case"Pattern":return e.alternatives.some((e=>C(e,t,r)));case"CharacterClass":return e.elements.some((e=>C(e,t,r)));case"CharacterClassRange":return C(e.min,t,r)||C(e.max,t,r);case"Quantifier":return C(e.element,t,r);case"RegExpLiteral":return C(e.pattern,t,r)||C(e.flags,t,r)}return!1}function x(e){switch(e.type){case"RegExpLiteral":return e.pattern;case"Pattern":return e;case"Flags":if(e.parent)return e.parent.pattern;throw new Error("Unable to find the pattern of flags without a RegExp literal.");default:{let t=e.parent;for(;"Pattern"!==t.type;)t=t.parent;return t}}}function g(e){let t;return m(e,(e=>"Assertion"===e.type&&(t=e,!0))),void 0===t||"lookahead"===t.kind?"ltr":"rtl"}function y(e){return"ltr"===e?"rtl":"ltr"}function k(e){return"end"===e||"lookahead"===e?"ltr":"rtl"}function v(e){const t=e.resolved,r=E(e,t);if(r===t)return!0;if("Alternative"!==r.type)return!0;const n=new Set;for(let t=e;t;t=t.parent)n.add(t);return!function e(t){const r=t.parent;switch(r.type){case"Alternative":{const a=r.elements.indexOf(t);let s;if(s="ltr"===g(t)?r.elements.slice(a+1):r.elements.slice(0,a),s.some((e=>n.has(e))))return!0;const o=r.parent;return"Pattern"!==o.type&&(("Assertion"!==o.type||!o.negate)&&e(o))}case"Quantifier":return e(r)}}(t)||c(t)}function w(e){const t=e.resolved,r=E(e,t);if(r===t)return!1;if("Alternative"!==r.type)return!1;const n=new Set;for(let t=e;t;t=t.parent)n.add(t);return function e(t){const r=t.parent;switch(r.type){case"Alternative":{const a=r.elements.indexOf(t);let s;if(s="ltr"===g(t)?r.elements.slice(a+1):r.elements.slice(0,a),s.some((e=>n.has(e))))return!0;const o=r.parent;return"Pattern"!==o.type&&(("Assertion"!==o.type||!o.negate)&&(!(o.alternatives.length>1)&&e(o)))}case"Quantifier":return 0!==r.min&&e(r)}}(t)}const S={min:0,max:0},A={min:1,max:1};function F(e){return n(e)?b(e):L(e)}function b(e){let t=1/0,r=0;for(const n of e){const e=L(n);e&&(t=Math.min(t,e.min),r=Math.max(r,e.max))}return t>r?void 0:{min:t,max:r}}function L(e){switch(e.type){case"Assertion":return S;case"Character":case"CharacterClass":case"CharacterSet":return A;case"Quantifier":{if(0===e.max)return S;const t=L(e.element);return t?0===t.max?S:{min:t.min*e.min,max:t.max*e.max}:0===e.min?S:void 0}case"Alternative":{let t=0,r=0;for(const n of e.elements){const e=L(n);if(!e)return;t+=e.min,r+=e.max}return{min:t,max:r}}case"CapturingGroup":case"Group":return b(e.alternatives);case"Backreference":if(v(e))return S;{const t=L(e.resolved);return t?t.min>0&&!w(e)?{min:0,max:t.max}:t:w(e)?S:void 0}default:throw r(e)}}function E(e,t){if(e===t)return e;if(e.parent&&e.parent===t.parent)return e.parent;{const r=_(e),n=_(t);for(;;){if(0===r.length)return e;if(0===n.length)return t;if(r[r.length-1]!==n[n.length-1])break;r.pop(),n.pop()}const a=r[r.length-1].parent;if(a)return a;throw new Error("The two nodes are not part of the same tree.")}}function _(e){const t=[];for(let r=e;r;r=r.parent)t.push(r);return t}function G(e){return new B(e)}class B{constructor(e){this.toCharSet=new WeakMap,this.getFirstConsumedCharLTR=new WeakMap,this.getFirstConsumedCharRTL=new WeakMap,this.dotAll=!!e.dotAll,this.global=!!e.global,this.hasIndices=!!e.hasIndices,this.ignoreCase=!!e.ignoreCase,this.multiline=!!e.multiline,this.sticky=!!e.sticky,this.unicode=!!e.unicode}}function W(e,r){if(!n(e))return O(e,r);if(1===e.length)return O(e[0],r);const{positive:a,negated:s}=function(e){const t=[],r=[];for(const n of e)"CharacterClass"===n.type?n.negate?r.push(n):t.push(...n.elements):t.push(n);return{positive:t,negated:r}}(e);return s.length?a.length?t.JS.createCharSet(J(a),r).union(...s.map((e=>t.JS.createCharSet(J(e.elements),r).negate()))):1===s.length?t.JS.createCharSet(J(s[0].elements),r).negate():exports.Chars.empty(r).union(...s.map((e=>t.JS.createCharSet(J(e.elements),r).negate()))):a.length?t.JS.createCharSet(J(a),r):exports.Chars.empty(r)}function O(e,t){if(t instanceof B){let r=t.toCharSet.get(e);return void 0===r&&(r=R(e,t),t.toCharSet.set(e,r)),r}return R(e,t)}function R(e,r){if("CharacterClass"===e.type){const n=t.JS.createCharSet(J(e.elements),r);return e.negate?n.negate():n}return t.JS.createCharSet([P(e)],r)}function J(e){return e.map(P)}function P(e){switch(e.type){case"Character":return e.value;case"CharacterClassRange":return{min:e.min.value,max:e.max.value};case"CharacterSet":return e;default:throw r(e)}}function M(e,t){if(e==t)return!0;if(!e||!t||e.type!=t.type)return!1;switch(e.type){case"Alternative":{const r=t;return Q(e.elements,r.elements)}case"Assertion":{const r=t;if(e.kind===r.kind){if("lookahead"===e.kind||"lookbehind"===e.kind){const r=t;return e.negate===r.negate&&Q(e.alternatives,r.alternatives)}return e.raw===r.raw}return!1}case"Backreference":{const r=t;return v(e)?v(r):M(e.resolved,r.resolved)&&w(e)==w(r)}case"Character":{const r=t;return e.value===r.value}case"CharacterClass":{const r=t;return e.negate===r.negate&&Q(e.elements,r.elements)}case"CharacterClassRange":{const r=t;return M(e.min,r.min)&&M(e.max,r.max)}case"CharacterSet":{const r=t;return"property"===e.kind&&"property"===r.kind?e.negate===r.negate&&e.key===r.key:e.raw===r.raw}case"Flags":{const r=t;return e.dotAll===r.dotAll&&e.global===r.global&&e.ignoreCase===r.ignoreCase&&e.multiline===r.multiline&&e.sticky===r.sticky&&e.unicode===r.unicode}case"CapturingGroup":case"Group":case"Pattern":{const r=t;return Q(e.alternatives,r.alternatives)}case"Quantifier":{const r=t;return e.min===r.min&&e.max===r.max&&e.greedy===r.greedy&&M(e.element,r.element)}case"RegExpLiteral":{const r=t;return M(e.flags,r.flags)&&M(e.pattern,r.pattern)}default:throw r(e)}}function Q(e,t){if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(!M(e[r],t[r]))return!1;return!0}function j(e,t,n,a,s){function o(e,t,r){var n,s;a.enter&&(t=a.enter(e,t,r));if(null===(s=null===(n=a.continueInto)||void 0===n?void 0:n.call(a,e,t,r))||void 0===s||s)switch(e.type){case"Assertion":if("lookahead"===e.kind||"lookbehind"===e.kind){const n=k(e.kind),s=a.join(e.alternatives.map((e=>i(e,T(a,t,r),n))),n);t=h(t,n,"assertion"),a.assert&&(t=a.assert(t,r,s,n))}break;case"Group":case"CapturingGroup":t=a.join(e.alternatives.map((e=>i(e,T(a,t,r),r))),r);break;case"Quantifier":0===e.max||(t=0===e.min?a.join([t,o(e.element,T(a,t,r),r)],r):o(e.element,t,r))}return a.leave&&(t=a.leave(e,t,r)),t}function i(e,t,r){var n,s;let i="ltr"===r?0:e.elements.length-1;const c="ltr"===r?1:-1;let u;for(;u=e.elements[i];i+=c){t=o(u,t,r);if(!(null===(s=null===(n=a.continueAfter)||void 0===n?void 0:n.call(a,u,t,r))||void 0===s||s))break}return t}function c(e,t,n){var s,o;const i=e.parent;if("CharacterClass"===i.type||"CharacterClassRange"===i.type)throw new Error("The given element cannot be part of a character class.");if(!(null===(o=null===(s=a.continueAfter)||void 0===s?void 0:s.call(a,e,t,n))||void 0===o||o))return!1;if("Quantifier"===i.type)return i.max<=1?c(i,t,n):[i,c(i,t,n)];{const a=i.elements.indexOf(e)+("ltr"===n?1:-1),s=i.elements[a];if(s)return s;{const e=i.parent;if("Pattern"===e.type)return"pattern";if("Assertion"===e.type)return u(e,t,n)?c(e,t,n):"assertion";if("CapturingGroup"===e.type||"Group"===e.type)return c(e,t,n);throw r(e)}}}function u(e,t,r){return!!a.continueOutside&&a.continueOutside(e,t,r)}function h(e,t,r){return a.endPath?a.endPath(e,t,r):e}if(s||(s=g(e)),"Alternative"===e.type)if(0===e.elements.length&&(t="next"),"enter"===t)l=e,e="ltr"===s?l.elements[0]:l.elements[l.elements.length-1];else{const t=e.parent;if("Pattern"===t.type)return h(n,s,"pattern");if("Assertion"===t.type&&!u(t,n,s))return h(n,s,"assertion");e=t}var l;return"enter"===t&&(n=o(e,n,s)),function(e,t,r){for(;;){let n=c(e,t,r);for(;Array.isArray(n);){const[e,s]=n;t=a.join([t,o(e,T(a,t,r),r)],r),n=s}if(!1===n)return t;if("assertion"===n||"pattern"===n)return h(t,r,n);t=o(n,t,r),e=n}}(e,n,s)}function T(e,t,r){return e.fork?e.fork(t,r):t}var D,I;exports.FirstLookChars=void 0,(D=exports.FirstLookChars||(exports.FirstLookChars={})).all=function(e){return{char:exports.Chars.all(e),exact:!0,edge:!0}},D.edge=function(e){return{char:exports.Chars.empty(e),exact:!0,edge:!0}},D.toConsumed=function(e){return!e.edge&&e.char.isEmpty?{char:t.CharSet.empty(e.char.maximum),exact:!0,empty:!1}:{char:t.CharSet.empty(e.char.maximum),exact:!0,empty:!0,look:e}},exports.FirstConsumedChars=void 0,(I=exports.FirstConsumedChars||(exports.FirstConsumedChars={})).emptyConcat=function(e){return{char:exports.Chars.empty(e),exact:!0,empty:!0,look:exports.FirstLookChars.all(e)}},I.emptyUnion=function(e){return{char:exports.Chars.empty(e),exact:!0,empty:!1}},I.toLook=function(e){if(e.empty){const t=function(e,t){const r=e.char.union(t.char);let n;return n=e.exact?!!t.exact||e.char.isSupersetOf(t.char):!!t.exact&&t.char.isSupersetOf(e.char),{char:r,exact:n}}(e,e.look);return{char:t.char,exact:t.exact,edge:e.look.edge}}return{char:e.char,exact:e.exact,edge:!1}},I.union=function(e,t){const r=a.fromFlags(t),n=[];for(const t of e)r.add(t),t.empty&&n.push(t.look);if(n.length>0){if(1===n.length)return{char:r.char,exact:r.exact,empty:!0,look:n[0]};const e=a.fromFlags(t);let s=!1;for(const t of n)e.add(t),s=s||t.edge;return{char:r.char,exact:r.exact,empty:!0,look:{char:e.char,exact:e.exact,edge:s}}}return{char:r.char,exact:r.exact,empty:!1}},I.concat=function(e,t){const r=a.fromFlags(t);let n=exports.FirstLookChars.all(t);for(const t of e){if(r.add(s(t,n)),!t.empty)return{char:r.char,exact:r.exact,empty:!1};{const e=s(n,t.look);if(n={char:e.char,exact:e.exact,edge:n.edge&&t.look.edge},!n.edge&&n.char.isEmpty)return{char:r.char,exact:r.exact,empty:!1}}}return{char:r.char,exact:r.exact,empty:!0,look:n}},I.makeOptional=function(e){return{char:e.char,exact:e.exact,empty:!0,look:{char:t.CharSet.all(e.char.maximum),exact:!0,edge:!0}}};class q{constructor(e){this._currentWordBoundaries=[],e instanceof B?(this._ltrCache=e.getFirstConsumedCharLTR,this._rtlCache=e.getFirstConsumedCharRTL):(this._ltrCache=new WeakMap,this._rtlCache=new WeakMap)}isCurrentWordBoundary(e){return this._currentWordBoundaries.some((t=>t===e))}pushWordBoundary(e){this._currentWordBoundaries.push(e)}popWordBoundary(){this._currentWordBoundaries.pop()}getCached(e,t){return"ltr"===t?this._ltrCache.get(e):this._rtlCache.get(e)}setCached(e,t,r){"ltr"===t?this._ltrCache.set(e,r):this._rtlCache.set(e,r)}}function U(e,t,r,n){return exports.FirstConsumedChars.union(e.map((e=>N(e,t,r,n))),r)}function N(e,t,n,a){let s=a.getCached(e,t);return void 0===s&&(s=function(e,t,n,a){switch(e.type){case"Assertion":return function(e,t,n,a){switch(e.kind){case"word":if(a.isCurrentWordBoundary(e))return s();{a.pushWordBoundary(e);const r=z(e,y(t),n,a);a.popWordBoundary();const o=exports.Chars.word(n);return r.edge?r.char.isDisjointWith(o)?c(e.negate):s():r.char.isDisjointWith(o)?c(e.negate):r.char.isSubsetOf(o)?c(!e.negate):s()}case"end":case"start":return k(e.kind)===t?n.multiline?i():o():s();case"lookahead":case"lookbehind":if(k(e.kind)===t){if(e.negate){if(d(e,(t=>t!==e&&"Assertion"===t.type)))return s();const r=U(e.alternatives,t,n,a),o=F(e.alternatives);return r.empty||!o?{char:exports.Chars.empty(n),empty:!1,exact:!0}:r.exact&&1===o.max?exports.FirstLookChars.toConsumed({char:r.char.negate(),edge:!0,exact:!0}):s()}{const r=U(e.alternatives,t,n,a);return exports.FirstLookChars.toConsumed(exports.FirstConsumedChars.toLook(r))}}return s();default:throw r(e)}function s(){return exports.FirstLookChars.toConsumed({char:exports.Chars.all(n),edge:!0,exact:!1})}function o(){return exports.FirstLookChars.toConsumed(exports.FirstLookChars.edge(n))}function i(){return exports.FirstLookChars.toConsumed({char:exports.Chars.lineTerminator(n),edge:!0,exact:!0})}function c(e){const t=exports.Chars.word(n);return exports.FirstLookChars.toConsumed({char:e?t.negate():t,edge:e,exact:!0})}}(e,t,n,a);case"Character":case"CharacterSet":case"CharacterClass":return{char:W(e,n),empty:!1,exact:!0};case"Quantifier":{if(0===e.max)return exports.FirstConsumedChars.emptyConcat(n);const r=N(e.element,t,n,a);return 0===e.min?exports.FirstConsumedChars.makeOptional(r):r}case"Alternative":{let r=e.elements;return"rtl"===t&&(r=[...r],r.reverse()),exports.FirstConsumedChars.concat(function*(){for(const e of r)yield N(e,t,n,a)}(),n)}case"CapturingGroup":case"Group":return U(e.alternatives,t,n,a);case"Backreference":{if(v(e))return exports.FirstConsumedChars.emptyConcat(n);let r=N(e.resolved,t,n,a);return r.exact&&r.char.size>1&&(r=Object.assign(Object.assign({},r),{exact:!1})),w(e)?r:exports.FirstConsumedChars.makeOptional(r)}default:throw r(e)}}(e,t,n,a),a.setCached(e,t,s)),s}function Z(e,t,r,n){return j(e,"next",exports.FirstConsumedChars.emptyConcat(r),{join:e=>exports.FirstConsumedChars.union(e,r),enter(e,t,a){const s=N(e,a,r,n);return exports.FirstConsumedChars.concat([t,s],r)},continueInto:()=>!1,continueAfter:(e,t)=>t.empty,continueOutside:(e,t,r)=>k(e.kind)!==r},t)}function z(e,t,r,n){return exports.FirstConsumedChars.toLook(Z(e,t,r,n))}function K(e,t,r,n){return j(e,"next",{char:exports.FirstConsumedChars.emptyConcat(r),contributors:[]},{join(e){const t=new Set;return e.forEach((e=>e.contributors.forEach((e=>t.add(e))))),{char:exports.FirstConsumedChars.union(e.map((e=>e.char)),r),contributors:[...t]}},enter(e,t,a){const s=N(e,a,r,n);return{char:exports.FirstConsumedChars.concat([t.char,s],r),contributors:[...t.contributors,e]}},continueInto:()=>!1,continueAfter:(e,t)=>t.char.empty,continueOutside:(e,t,r)=>k(e.kind)!==r},t)}exports.createCache=G,exports.followPaths=j,exports.getCapturingGroupNumber=function(t){let r=0;try{throw e.visitRegExpAST(x(t),{onCapturingGroupEnter(e){if(r++,e===t)throw new Error}}),new Error("Unable to find the given capturing group in its parent pattern.")}catch(e){return r}},exports.getClosestAncestor=E,exports.getEffectiveMaximumRepetition=function(e){let t=1;for(let r=e.parent;r;r=r.parent)if("Quantifier"===r.type){if(t*=r.max,0===t)return 0}else if("Assertion"===r.type)break;return t},exports.getFirstCharAfter=function(e,t,r){return z(e,t,r,new q(r))},exports.getFirstCharAfterWithContributors=function(e,t,r){return function(e,t,r,n){const{char:a,contributors:s}=K(e,t,r,n);return{char:exports.FirstConsumedChars.toLook(a),contributors:s}}(e,t,r,new q(r))},exports.getFirstConsumedChar=function(e,t,r){const a=new q(r);return n(e)?U(e,t,r,a):N(e,t,r,a)},exports.getFirstConsumedCharAfter=function(e,t,r){return Z(e,t,r,new q(r))},exports.getFirstConsumedCharAfterWithContributors=function(e,t,r){return K(e,t,r,new q(r))},exports.getLengthRange=F,exports.getMatchingDirection=g,exports.getMatchingDirectionFromAssertionKind=k,exports.getPattern=x,exports.hasSomeAncestor=m,exports.hasSomeDescendant=d,exports.invertMatchingDirection=y,exports.isEmpty=function(e){return o(e,l)},exports.isEmptyBackreference=v,exports.isPotentiallyEmpty=function(e){return i(e,p)},exports.isPotentiallyZeroLength=function(e){return i(e,(e=>h(e,e)))},exports.isStrictBackreference=w,exports.isZeroLength=c,exports.matchesAllCharacters=function(e,t){return"Character"!==e.type&&("CharacterClassRange"===e.type?0===e.min.value&&e.max.value===(t.unicode?1114111:65535):"CharacterSet"===e.type?"property"===e.kind?W(e,t).isAll:"any"===e.kind&&!!t.dotAll:!(!e.negate||0!==e.elements.length)||(e.negate?W(e.elements,t).isEmpty:W(e.elements,t).isAll))},exports.matchesNoCharacters=function(e,t){return"Character"!==e.type&&"CharacterClassRange"!==e.type&&("CharacterSet"===e.type?"property"===e.kind&&W(e,t).isEmpty:!e.negate&&0===e.elements.length||(e.negate?W(e.elements,t).isAll:W(e.elements,t).isEmpty))},exports.structurallyEqual=M,exports.toCache=function(e){return e instanceof B?e:G(e)},exports.toCharSet=W;
