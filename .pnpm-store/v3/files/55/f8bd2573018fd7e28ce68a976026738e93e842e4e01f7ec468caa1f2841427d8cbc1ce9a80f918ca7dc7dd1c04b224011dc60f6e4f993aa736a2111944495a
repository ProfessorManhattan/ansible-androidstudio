"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("refa"),t=require("regexp-ast-analysis"),r=require("regexpp");function n(e,t){const r=new Error(t);throw r.data=e,r}function a(t,r){return e.JS.toLiteral({type:"CharacterClass",characters:t},{flags:r})}function s(e){switch(e.type){case"Character":case"CharacterClass":case"CharacterSet":return!0;default:return!1}}function i(e,r){if(Array.isArray(e)){if(0===e.length)return{consume:t.Chars.empty(r),assert:t.Chars.all(r)};if(1===e.length)return e[0]}let n=t.Chars.empty(r),a=t.Chars.all(r);for(const t of e)if(n=n.intersect(t.consume.union(t.assert)).union(t.consume.intersect(a)),a=a.intersect(t.assert),a.isEmpty&&n.isEmpty)break;return{consume:n,assert:a}}function o(e,r){if(Array.isArray(e)&&1===e.length)return e[0];let n=t.Chars.empty(r),a=t.Chars.empty(r);for(const t of e)n=n.union(t.consume),a=a.union(t.assert);return{consume:n,assert:a}}function c(t){return{consume:e.CharSet.empty(t.consume.maximum),assert:t.consume.union(t.assert)}}function u(e,r){if(Array.isArray(e))return o(e.map((e=>u(e,r))),r);switch(e.type){case"Alternative":return i(function*(){for(const t of e.elements)yield u(t,r)}(),r);case"Assertion":switch(e.kind){case"end":case"start":return r.multiline?{consume:t.Chars.empty(r),assert:t.Chars.lineTerminator(r)}:{consume:t.Chars.empty(r),assert:t.Chars.empty(r)};case"word":{const n=t.Chars.word(r),a=n.negate();for(const s of["ltr","rtl"]){const i=t.getFirstCharAfter(e,s,r);if(!i.edge){if(i.char.isSubsetOf(n))return{consume:t.Chars.empty(r),assert:e.negate?n:a};if(i.char.isSubsetOf(a))return{consume:t.Chars.empty(r),assert:e.negate?a:n}}}return e.negate?{consume:t.Chars.empty(r),assert:t.Chars.all(r)}:{consume:t.Chars.empty(r),assert:t.Chars.empty(r)}}case"lookahead":case"lookbehind":{const n=c(u(e.alternatives,r));return e.negate?{consume:t.Chars.empty(r),assert:n.assert.negate()}:n}}throw n(e);case"CapturingGroup":case"Group":case"Pattern":return u(e.alternatives,r);case"Character":case"CharacterClass":case"CharacterSet":return{consume:t.toCharSet(e,r),assert:t.Chars.empty(r)};case"Quantifier":return 0===e.max?{consume:t.Chars.empty(r),assert:t.Chars.all(r)}:0===e.min?{consume:u(e.element,r).consume,assert:t.Chars.all(r)}:u(e.element,r);case"RegExpLiteral":return u(e.pattern,r);case"Backreference":if(t.isEmptyBackreference(e))return{consume:t.Chars.empty(r),assert:t.Chars.all(r)};{const n=u(e.resolved,r);return t.isStrictBackreference(e)?n:{consume:n.consume,assert:t.Chars.all(r)}}case"CharacterClassRange":case"Flags":throw new Error("This doesn't make any sense");default:n(e)}}function l(e,r,a,s,i){return 1===t.followPaths(e,"enter",0,{fork:e=>e,join:e=>e.every((e=>2===e))?2:e.some((e=>1===e))?1:0,assert:(e,t,r)=>1===r?r:e,continueAfter:(t,r)=>t!==e&&0===r,continueInto:(e,t)=>0===t,enter:(e,t)=>e===r?1:t,leave(e,t){if(0!==t)return t;switch(e.type){case"Assertion":case"Backreference":case"Character":case"CharacterClass":case"CharacterSet":{const t=u(e,i),r=t.consume.union(t.assert);return a.isSubsetOf(r)?0:2}case"CapturingGroup":case"Group":case"Quantifier":return t;default:n(e)}}},s)}function m(e){let r=t.getEffectiveMaximumRepetition(e);return"Quantifier"===e.type&&(r*=e.max),r>20}function f(e){let t;if(0===e.min&&1===e.max)t="?";else if(0===e.min&&e.max===1/0)t="*";else if(1===e.min&&e.max===1/0)t="+";else{if(e.min===e.max)return 1===e.min?"":`{${e.min}}`;t=e.max===1/0?`{${e.min},}`:`{${e.min},${e.max}}`}return e.greedy||(t+="?"),t}function p(e,r,n){return e.element.raw===r.element.raw||!(!s(e.element)||!s(r.element))&&t.toCharSet(e.element,n).equals(t.toCharSet(r.element,n))}function h(e,t){return"ltr"===e?t.join(""):[...t].reverse().join("")}function g(e,t){return 0===t?"":1===t?e.raw:e.raw+`{${t}}`}function y(e){return t.hasSomeDescendant(e,(e=>"CapturingGroup"===e.type))}class C{constructor(e){this.source=e.pattern.raw,this.flags=e.flags.raw,this.patternOffset=e.pattern.start}replace(e,t){let r,n;if(Array.isArray(e)){r=1/0,n=-1/0;for(const t of e)r=Math.min(r,t.start),n=Math.max(n,t.end)}else r=e.start,n=e.end;const a=this.patternOffset;return{source:this.source.slice(0,r-a)+t+this.source.slice(n-a),flags:this.flags}}}function d(r,n){const{startQuant:a,endQuant:i}=n;if(y(a)||y(i))return;const o=new C(r);if(a.parent===i.parent){const n=t.getMatchingDirection(a);if(n===(a.start<i.start?"ltr":"rtl")){const c=a.parent.elements,u=c.indexOf(a),l=c.indexOf(i),m=c.slice(Math.min(u,l)+1,Math.max(u,l));if(0===m.length)return function(e,t,r,n,a){if(p(n,a,e.flags))return t.replace([n,a],n.element.raw+f({min:n.min+a.min,max:1/0,greedy:n.greedy||a.greedy}));if(s(n.element)&&s(a.element)){const{which:s,replacement:i}=w(e.flags,r,n,a);return t.replace(s,i)}}(r,o,n,a,i);if(1===m.length){const c=m[0];if("Quantifier"===c.type)return function(e,r,n,a,i,o){if(0===o.max||0!==o.min||t.isPotentiallyZeroLength(a.element)||t.isPotentiallyZeroLength(i.element)||t.isPotentiallyZeroLength(o.element))return;const c=t.getFirstConsumedChar(a.element,n,e.flags),u=t.getFirstConsumedChar(i.element,n,e.flags),l=t.getFirstConsumedChar(o.element,n,e.flags);function m(e){return 3===a.parent.elements.length?e.join("|"):"(?:"+e.join("|")+")"}function g(){return o.element.raw+f(Object.assign(Object.assign({},o),{min:1}))}const C=o.greedy?"":"?";if(c.char.isDisjointWith(l.char)&&u.char.isDisjointWith(l.char)){if(p(a,i,e.flags)){if(0===i.min)return r.replace([o,i],"(?:"+h(n,[g(),i.raw])+")?"+C);if(0===a.min){if(y(o))return r.replace([a,o],"(?:"+h(n,[a.raw,g()])+")?"+C);{const e=h(n,[g(),i.raw]),t=[h(n,[a.element.raw+f(Object.assign(Object.assign({},a),{min:1})),"(?:"+e+")?"+C]),e];return o.greedy||t.reverse(),r.replace([a,o,i],m(t))}}}if(s(a.element)&&s(i.element)){const{which:t,replacement:s}=w(e.flags,n,a,i);if(""===s)return t===a?r.replace([a,o],"(?:"+h(n,[a.raw,g()])+")?"+C):r.replace([o,i],"(?:"+h(n,[g(),i.raw])+")?"+C);{const e=[h(n,[a.raw,g(),i.raw]),h(n,[a===t?s:a.raw,i===t?s:i.raw])];return o.greedy||e.reverse(),r.replace([a,o,i],m(e))}}}}(r,o,n,a,i,c);if(s(c))return function(r,n,a,i,o,c){if(i.element.raw===o.element.raw&&i.element.raw===c.raw)return n.replace([i,c,o],i.element.raw+f({min:i.min+o.min+1,max:1/0,greedy:i.greedy||o.greedy}));if(s(i.element)&&s(o.element)&&i.greedy&&o.greedy){const s=t.toCharSet(i.element,r.flags),u=t.toCharSet(o.element,r.flags),l=t.toCharSet(c,r.flags),m={type:"Concatenation",elements:[{type:"Quantifier",min:i.min,max:1/0,lazy:!1,alternatives:[{type:"Concatenation",elements:[{type:"CharacterClass",characters:s}]}]},{type:"CharacterClass",characters:l},{type:"Quantifier",min:o.min,max:1/0,lazy:!1,alternatives:[{type:"Concatenation",elements:[{type:"CharacterClass",characters:u}]}]}]};"rtl"===a&&m.elements.reverse();const f=e.DFA.fromFA(e.NFA.fromRegex(m,{maxCharacter:s.maximum}));f.minimize();const p=f.toRegex(),h=e.JS.toLiteral(p,{flags:r.flags}).source,g=p.alternatives.length>1?"(?:"+h+")":h;return n.replace([i,c,o],g)}}(r,o,n,a,i,c)}}}}function w(e,r,n,s){const i=t.toCharSet(n.element,e),o=t.toCharSet(s.element,e);let c;if(c=i.isSubsetOf(o)?n:o.isSubsetOf(i)?s:void 0,c)return{which:c,replacement:g(c.element,c.min)};const u=a(o.without(i),e).source,l=s.element.raw+f({min:Math.max(0,s.min-1),max:1/0,greedy:s.greedy});let m;if(0===s.min){const e=s.greedy?"":"?";m=`(?:${h(r,[u,l])})?${e}`}else{const t=a(o.intersect(i),e).source,n=g(s.element,s.min-1);m=`(?:${h(r,[u,l])}|${h(r,[t,n])})`}return{which:s,replacement:m}}const x=()=>{};function v(t){return{set:t,pick:String.fromCodePoint(e.Words.pickMostReadableCharacter(t)),literal:a(t)}}function S(e,r){return t.hasSomeAncestor(r,(t=>t===e))}const A=new r.RegExpParser;exports.analyse=function(e,a){const{pattern:s,flags:p}=function(e){if("source"in e){const t=A.parseFlags(e.flags);return{pattern:A.parsePattern(e.source,void 0,void 0,t.unicode),flags:t}}return e}(e),{maxReports:h,reportTypes:g,assumeRejectingSuffix:y}=function(e){var t,r,n;return{maxReports:null!==(t=null==e?void 0:e.maxReports)&&void 0!==t?t:1/0,reportTypes:null!==(r=null==e?void 0:e.reportTypes)&&void 0!==r?r:{},assumeRejectingSuffix:null!==(n=null==e?void 0:e.assumeRejectingSuffix)&&void 0!==n&&n}}(a),w={parsed:{pattern:s,flags:p},literal:{source:s.raw,flags:p.raw},reports:[]};if(h<=0)return w;function b(e){w.reports.length<h&&!1!==g[e.type]&&(!function(e,t){switch(t.type){case"Move":break;case"Self":t.fix=()=>{const r=function(e,t){const{quant:r,parentQuant:n}=t;if(r.greedy!==n.greedy)return;const a=new C(e);if(1===r.parent.elements.length&&"Group"===r.parent.parent.type&&r.parent.parent.parent===n){if(1===r.parent.parent.alternatives.length){const e=r.min,t=r.max,s=n.min,i=n.max;if(t===1/0&&0===s?e<=1:s===i||t*s+1>=e*(s+1)){const o={min:e*s,max:t*i,greedy:r.greedy};return a.replace(n,r.element.raw+f(o))}}if(n.max===1/0){if(1===r.min||0===r.min&&0===n.min)return a.replace(r,r.element.raw);if(0===r.min)return a.replace(r,r.element.raw+f({min:0,max:1,greedy:r.greedy}))}}}(e,t);return r||void 0};break;case"Trade":t.fix=()=>{const r=d(e,t);return r||void 0};break;default:n(t)}}(w.parsed,e),w.reports.push(e))}const j=function(e){const t=new Map;return function(r){let n=t.get(r);return void 0===n&&(n=e(r),t.set(r,n)),n}}((e=>u(e,p))),O={fork:e=>e,join:e=>o(e,p),continueAfter:(e,t)=>!(t.assert.isEmpty&&t.consume.isEmpty)&&w.reports.length<h,continueInto:(e,t)=>!(t.assert.isEmpty&&t.consume.isEmpty)&&w.reports.length<h,leave(e,t){switch(e.type){case"Assertion":case"Backreference":case"Character":case"CharacterClass":case"CharacterSet":return i([t,j(e)],p);case"CapturingGroup":case"Group":case"Quantifier":return t;default:n(e)}}},Q=new Map,E=new Map;function k(e,t,r){let n=e.get(t);return void 0===n&&(n=new Set,e.set(t,n)),!!n.has(r)||(n.add(r),!1)}function M(e,r){const n=j(r).consume.intersect(e.consume.union(e.assert));if(n.isEmpty)return n;if(y)return n;{const e=c((a=r,t.followPaths(a,"next",{consume:t.Chars.empty(p),assert:t.Chars.all(p)},O))).assert;return n.without(e)}var a}function R(e,r,n){if(r.max!==1/0)return;const a=M(n,r);if(a.isEmpty)return;let s,i,o;e===r?(s=e,i=function(e){let t=e.parent;for(;t;){if("Quantifier"===t.type)return t;t=t.parent}throw new Error("Cannot get parent quant of `"+e.raw+"`")}(e)):S(r,e)?(s=e,i=r):S(e,r)&&(s=r,i=e),s&&i&&(o=function(e,t){let r,n=t.parent;for(;n;){if(n===e)return r;"Assertion"===n.type&&(r=n),n=n.parent}throw new Error("The given nodes are not parent and child.")}(i,s))?k(E,e,o)||b({type:"Trade",startQuant:e,endQuant:r,character:v(a),fix:x,exponential:!1}):s&&i&&l(i,s,a,"ltr",p)&&l(i,s,a,"rtl",p)?k(Q,s,i)||b({type:"Self",quant:s,parentQuant:i,character:v(a),fix:x,exponential:m(i)}):k(E,e,r)||b({type:"Trade",startQuant:e,endQuant:r,character:v(a),fix:x,exponential:m(t.getClosestAncestor(e,r))})}if(r.visitRegExpAST(s,{onQuantifierLeave(e){if(e.max!==1/0)return;if(w.reports.length>=h)return;const r=j(e.element);r.consume.isEmpty||(t.followPaths(e,"next",r,Object.assign(Object.assign({},O),{enter:(t,r)=>("Quantifier"===t.type&&R(e,t,r),r)})),t.followPaths(e,"enter",r,Object.assign(Object.assign({},O),{enter:(t,r)=>(t!==e&&"Quantifier"===t.type&&R(e,t,r),r),continueAfter:(t,r,n)=>O.continueAfter(t,r,n)&&t!==e})))}}),!p.sticky&&w.reports.length<h&&!1!==g.Move){function P(e,t){if(e.max!==1/0)return;const r=M(t,e);r.isEmpty||b({type:"Move",quant:e,character:v(r),fix:x,exponential:!1})}const e={consume:t.Chars.all(p),assert:t.Chars.empty(p)};for(const r of s.alternatives)0!==r.elements.length&&t.followPaths(r.elements[0],"enter",e,Object.assign(Object.assign({},O),{enter:(e,t)=>("Quantifier"===e.type&&P(e,t),t)}))}return w};
