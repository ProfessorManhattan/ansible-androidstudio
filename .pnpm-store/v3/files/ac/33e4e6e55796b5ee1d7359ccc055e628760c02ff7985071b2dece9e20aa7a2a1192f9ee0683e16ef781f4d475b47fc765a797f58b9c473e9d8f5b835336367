"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.printers = exports.parsers = exports.languages = exports.options = void 0;
const prettier_1 = require("prettier");
const doc_1 = require("prettier/doc");
const parser_html_1 = require("prettier/parser-html");
const parse_1 = require("./parse");
const htmlParser = parser_html_1.parsers.html;
const PLUGIN_KEY = "go-template";
exports.options = {
    goTemplateBracketSpacing: {
        type: "boolean",
        category: "Global",
        description: "Specifies whether the brackets should have spacing around the statement.",
        default: true,
    },
};
exports.languages = [
    {
        name: "GoTemplate",
        parsers: [PLUGIN_KEY],
        extensions: [
            ".go.html",
            ".gohtml",
            ".gotmpl",
            ".go.tmpl",
            ".tmpl",
            ".tpl",
            ".html.tmpl",
            ".html.tpl",
        ],
        vscodeLanguageIds: ["gotemplate", "gohtml", "GoTemplate", "GoHTML"],
    },
];
exports.parsers = {
    [PLUGIN_KEY]: Object.assign(Object.assign({}, htmlParser), { astFormat: PLUGIN_KEY, preprocess: (text) => text, parse: parse_1.parseGoTemplate, locStart: (node) => node.index, locEnd: (node) => node.index + node.length }),
};
exports.printers = {
    [PLUGIN_KEY]: {
        print: (path, options, print) => {
            const node = path.getNode();
            switch (node === null || node === void 0 ? void 0 : node.type) {
                case "inline":
                    return printInline(node, path, options, print);
                case "double-block":
                    return printMultiBlock(node, path, print);
                case "unformattable":
                    return printPlainBlock(node.content, false);
            }
            console.error(`An error occured during printing. Found invalid node ${node === null || node === void 0 ? void 0 : node.type}`);
            return options.originalText;
        },
        embed: (path, print, textToDoc, options) => {
            try {
                return embed(path, print, textToDoc, options);
            }
            catch (e) {
                console.error("Formatting failed.", e);
            }
            return options.originalText;
        },
    },
};
const embed = (path, print, textToDoc, options) => {
    const node = path.getNode();
    if (!node) {
        return null;
    }
    if (hasPrettierIgnoreLine(node)) {
        return options.originalText.substring(options.locStart(node), options.locEnd(node));
    }
    if (node.type !== "block" && node.type !== "root") {
        return null;
    }
    const html = textToDoc(node.aliasedContent, Object.assign(Object.assign({}, options), { parser: "html", parentParser: "go-template" }));
    const mapped = prettier_1.doc.utils.mapDoc(html, (currentDoc) => {
        if (typeof currentDoc !== "string") {
            return currentDoc;
        }
        let result = currentDoc;
        Object.keys(node.children).forEach((key) => (result = prettier_1.doc.utils.mapDoc(result, (docNode) => typeof docNode !== "string" || !docNode.includes(key)
            ? docNode
            : doc_1.builders.concat([
                docNode.substring(0, docNode.indexOf(key)),
                path.call(print, "children", key),
                docNode.substring(docNode.indexOf(key) + key.length),
            ]))));
        return result;
    });
    if (node.type === "root") {
        return mapped;
    }
    if (Array.isArray(mapped)) {
        mapped.pop();
    }
    const startStatement = path.call(print, "start");
    const endStatement = node.end ? path.call(print, "end") : "";
    if (isPrettierIgnoreBlock(node)) {
        return doc_1.builders.concat([
            doc_1.utils.removeLines(path.call(print, "start")),
            printPlainBlock(node.content),
            endStatement,
        ]);
    }
    const content = node.aliasedContent.trim()
        ? doc_1.builders.indent(doc_1.builders.concat([doc_1.builders.softline, mapped]))
        : "";
    const result = doc_1.builders.concat([
        startStatement,
        content,
        doc_1.builders.softline,
        endStatement,
    ]);
    const emptyLine = !!node.end && isFollowedByEmptyLine(node.end, options.originalText)
        ? doc_1.builders.softline
        : "";
    if (parse_1.isMultiBlock(node.parent)) {
        return doc_1.builders.concat([result, emptyLine]);
    }
    return doc_1.builders.group(doc_1.builders.concat([doc_1.builders.group(result), emptyLine]), {
        shouldBreak: !!node.end && hasNodeLinebreak(node.end, options.originalText),
    });
};
function printMultiBlock(node, path, print) {
    return doc_1.builders.concat([...path.map(print, "blocks")]);
}
function printInline(node, path, options, print) {
    const hasLineBreak = hasNodeLinebreak(node, options.originalText);
    const result = [
        printStatement(node.statement, options.goTemplateBracketSpacing, {
            start: node.startDelimiter,
            end: node.endDelimiter,
        }),
    ];
    return doc_1.builders.group(doc_1.builders.concat([
        ...result,
        isFollowedByEmptyLine(node, options.originalText)
            ? doc_1.builders.softline
            : "",
    ]), {
        shouldBreak: hasLineBreak && !isBlockEnd(node) && !isBlockStart(node),
    });
}
function isBlockEnd(node) {
    const { parent } = getFirstBlockParent(node);
    return parse_1.isBlock(parent) && parent.end === node;
}
function isBlockStart(node) {
    const { parent } = getFirstBlockParent(node);
    return parse_1.isBlock(parent) && parent.start === node;
}
function printStatement(statement, addSpaces, delimiter = {
    start: "",
    end: "",
}) {
    const space = addSpaces ? " " : "";
    const shouldBreak = statement.includes("\n");
    const content = shouldBreak
        ? statement
            .trim()
            .split("\n")
            .map((line, _, array) => array.indexOf(line) === array.length - 1
            ? doc_1.builders.concat([line.trim(), doc_1.builders.softline])
            : doc_1.builders.indent(doc_1.builders.concat([line.trim(), doc_1.builders.softline])))
        : [statement.trim()];
    return doc_1.builders.group(doc_1.builders.concat([
        "{{",
        delimiter.start,
        space,
        ...content,
        shouldBreak ? "" : space,
        delimiter.end,
        "}}",
    ]), { shouldBreak });
}
function hasPrettierIgnoreLine(node) {
    if (parse_1.isRoot(node)) {
        return false;
    }
    const { parent, child } = getFirstBlockParent(node);
    const regex = new RegExp(`(?:<!--|{{).*?prettier-ignore.*?(?:-->|}})\n.*${child.id}`);
    return !!parent.aliasedContent.match(regex);
}
function isPrettierIgnoreBlock(node) {
    return node.type === "block" && node.keyword === "prettier-ignore-start";
}
function hasNodeLinebreak(node, source) {
    const start = node.index + node.length;
    const end = source.indexOf("\n", start);
    const suffix = source.substring(start, end);
    return !suffix;
}
function isFollowedByEmptyLine(node, source) {
    const start = node.index + node.length;
    const firstLineBreak = source.indexOf("\n", start);
    const secondLineBreak = source.indexOf("\n", firstLineBreak + 1);
    const emptyLine = source
        .substring(firstLineBreak + 1, secondLineBreak)
        .trim();
    const isLastNode = !!source.substring(start).match(/^\s*$/);
    return (firstLineBreak !== -1 && secondLineBreak !== -1 && !emptyLine && !isLastNode);
}
function getFirstBlockParent(node) {
    let previous = node;
    let current = node.parent;
    while (!parse_1.isBlock(current) && !parse_1.isRoot(current)) {
        previous = current;
        current = current.parent;
    }
    return {
        child: previous,
        parent: current,
    };
}
function printPlainBlock(text, hardlines = true) {
    const isTextEmpty = (input) => !!input.match(/^\s*$/);
    const lines = text.split("\n");
    const segments = lines.filter((value, i) => !(i == 0 || i == lines.length - 1) || !isTextEmpty(value));
    return doc_1.builders.concat([
        ...segments.map((content, i) => doc_1.builders.concat([
            hardlines || i ? doc_1.builders.hardline : "",
            doc_1.builders.trim,
            content,
        ])),
        hardlines ? doc_1.builders.hardline : "",
    ]);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsdUNBT2tCO0FBQ2xCLHNDQUErQztBQUMvQyxzREFBOEQ7QUFDOUQsbUNBWWlCO0FBRWpCLE1BQU0sVUFBVSxHQUFHLHFCQUFXLENBQUMsSUFBSSxDQUFDO0FBQ3BDLE1BQU0sVUFBVSxHQUFHLGFBQWEsQ0FBQztBQVNwQixRQUFBLE9BQU8sR0FFaEI7SUFDRix3QkFBd0IsRUFBRTtRQUN4QixJQUFJLEVBQUUsU0FBUztRQUNmLFFBQVEsRUFBRSxRQUFRO1FBQ2xCLFdBQVcsRUFDVCwwRUFBMEU7UUFDNUUsT0FBTyxFQUFFLElBQUk7S0FDZDtDQUNGLENBQUM7QUFFVyxRQUFBLFNBQVMsR0FBc0I7SUFDMUM7UUFDRSxJQUFJLEVBQUUsWUFBWTtRQUNsQixPQUFPLEVBQUUsQ0FBQyxVQUFVLENBQUM7UUFDckIsVUFBVSxFQUFFO1lBQ1YsVUFBVTtZQUNWLFNBQVM7WUFDVCxTQUFTO1lBQ1QsVUFBVTtZQUNWLE9BQU87WUFDUCxNQUFNO1lBQ04sWUFBWTtZQUNaLFdBQVc7U0FDWjtRQUNELGlCQUFpQixFQUFFLENBQUMsWUFBWSxFQUFFLFFBQVEsRUFBRSxZQUFZLEVBQUUsUUFBUSxDQUFDO0tBQ3BFO0NBQ0YsQ0FBQztBQUNXLFFBQUEsT0FBTyxHQUFHO0lBQ3JCLENBQUMsVUFBVSxDQUFDLEVBQUUsZ0NBQ1QsVUFBVSxLQUNiLFNBQVMsRUFBRSxVQUFVLEVBQ3JCLFVBQVUsRUFBRSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsSUFBSSxFQUMxQixLQUFLLEVBQUUsdUJBQWUsRUFDdEIsUUFBUSxFQUFFLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUM5QixNQUFNLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sR0FDM0M7Q0FDRixDQUFDO0FBQ1csUUFBQSxRQUFRLEdBQUc7SUFDdEIsQ0FBQyxVQUFVLENBQUMsRUFBbUI7UUFDN0IsS0FBSyxFQUFFLENBQUMsSUFBSSxFQUFFLE9BQThCLEVBQUUsS0FBSyxFQUFFLEVBQUU7WUFDckQsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBRTVCLFFBQVEsSUFBSSxhQUFKLElBQUksdUJBQUosSUFBSSxDQUFFLElBQUksRUFBRTtnQkFDbEIsS0FBSyxRQUFRO29CQUNYLE9BQU8sV0FBVyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO2dCQUNqRCxLQUFLLGNBQWM7b0JBQ2pCLE9BQU8sZUFBZSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7Z0JBQzVDLEtBQUssZUFBZTtvQkFDbEIsT0FBTyxlQUFlLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQzthQUMvQztZQUVELE9BQU8sQ0FBQyxLQUFLLENBQ1gsd0RBQXdELElBQUksYUFBSixJQUFJLHVCQUFKLElBQUksQ0FBRSxJQUFJLEVBQUUsQ0FDckUsQ0FBQztZQUVGLE9BQU8sT0FBTyxDQUFDLFlBQVksQ0FBQztRQUM5QixDQUFDO1FBQ0QsS0FBSyxFQUFFLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLEVBQUU7WUFDekMsSUFBSTtnQkFDRixPQUFPLEtBQUssQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQzthQUMvQztZQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUNWLE9BQU8sQ0FBQyxLQUFLLENBQUMsb0JBQW9CLEVBQUUsQ0FBQyxDQUFDLENBQUM7YUFDeEM7WUFFRCxPQUFPLE9BQU8sQ0FBQyxZQUFZLENBQUM7UUFDOUIsQ0FBQztLQUNGO0NBQ0YsQ0FBQztBQUVGLE1BQU0sS0FBSyxHQUFpRCxDQUMxRCxJQUFJLEVBQ0osS0FBSyxFQUNMLFNBQVMsRUFDVCxPQUFPLEVBQ1AsRUFBRTtJQUNGLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUU1QixJQUFJLENBQUMsSUFBSSxFQUFFO1FBQ1QsT0FBTyxJQUFJLENBQUM7S0FDYjtJQUVELElBQUkscUJBQXFCLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDL0IsT0FBTyxPQUFPLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FDbkMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFDdEIsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FDckIsQ0FBQztLQUNIO0lBRUQsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLE9BQU8sSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLE1BQU0sRUFBRTtRQUNqRCxPQUFPLElBQUksQ0FBQztLQUNiO0lBRUQsTUFBTSxJQUFJLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQyxjQUFjLGtDQUNyQyxPQUFPLEtBQ1YsTUFBTSxFQUFFLE1BQU0sRUFDZCxZQUFZLEVBQUUsYUFBYSxJQUMzQixDQUFDO0lBRUgsTUFBTSxNQUFNLEdBQUcsY0FBRyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUMsVUFBVSxFQUFFLEVBQUU7UUFDbkQsSUFBSSxPQUFPLFVBQVUsS0FBSyxRQUFRLEVBQUU7WUFDbEMsT0FBTyxVQUFVLENBQUM7U0FDbkI7UUFFRCxJQUFJLE1BQU0sR0FBaUIsVUFBVSxDQUFDO1FBRXRDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE9BQU8sQ0FDaEMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUNOLENBQUMsTUFBTSxHQUFHLGNBQUcsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQzdDLE9BQU8sT0FBTyxLQUFLLFFBQVEsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDO1lBQ25ELENBQUMsQ0FBQyxPQUFPO1lBQ1QsQ0FBQyxDQUFDLGNBQVEsQ0FBQyxNQUFNLENBQUM7Z0JBQ2QsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDMUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsVUFBVSxFQUFFLEdBQUcsQ0FBQztnQkFDakMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUM7YUFDckQsQ0FBQyxDQUNQLENBQUMsQ0FDTCxDQUFDO1FBRUYsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssTUFBTSxFQUFFO1FBQ3hCLE9BQU8sTUFBTSxDQUFDO0tBQ2Y7SUFFRCxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUU7UUFDekIsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDO0tBQ2Q7SUFFRCxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQztJQUNqRCxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBRTdELElBQUkscUJBQXFCLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDL0IsT0FBTyxjQUFRLENBQUMsTUFBTSxDQUFDO1lBQ3JCLFdBQUssQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDNUMsZUFBZSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDN0IsWUFBWTtTQUNiLENBQUMsQ0FBQztLQUNKO0lBRUQsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUU7UUFDeEMsQ0FBQyxDQUFDLGNBQVEsQ0FBQyxNQUFNLENBQUMsY0FBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLGNBQVEsQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUMvRCxDQUFDLENBQUMsRUFBRSxDQUFDO0lBRVAsTUFBTSxNQUFNLEdBQUcsY0FBUSxDQUFDLE1BQU0sQ0FBQztRQUM3QixjQUFjO1FBQ2QsT0FBTztRQUNQLGNBQVEsQ0FBQyxRQUFRO1FBQ2pCLFlBQVk7S0FDYixDQUFDLENBQUM7SUFFSCxNQUFNLFNBQVMsR0FDYixDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxZQUFZLENBQUM7UUFDakUsQ0FBQyxDQUFDLGNBQVEsQ0FBQyxRQUFRO1FBQ25CLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFFVCxJQUFJLG9CQUFZLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1FBQzdCLE9BQU8sY0FBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDO0tBQzdDO0lBRUQsT0FBTyxjQUFRLENBQUMsS0FBSyxDQUFDLGNBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxjQUFRLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFDLEVBQUU7UUFDMUUsV0FBVyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLGdCQUFnQixDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLFlBQVksQ0FBQztLQUM1RSxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUM7QUFJRixTQUFTLGVBQWUsQ0FDdEIsSUFBa0IsRUFDbEIsSUFBc0IsRUFDdEIsS0FBYztJQUVkLE9BQU8sY0FBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3pELENBQUM7QUFFRCxTQUFTLFdBQVcsQ0FDbEIsSUFBYyxFQUNkLElBQXNCLEVBQ3RCLE9BQThCLEVBQzlCLEtBQWM7SUFFZCxNQUFNLFlBQVksR0FBRyxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBRWxFLE1BQU0sTUFBTSxHQUFtQjtRQUM3QixjQUFjLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsd0JBQXdCLEVBQUU7WUFDL0QsS0FBSyxFQUFFLElBQUksQ0FBQyxjQUFjO1lBQzFCLEdBQUcsRUFBRSxJQUFJLENBQUMsWUFBWTtTQUN2QixDQUFDO0tBQ0gsQ0FBQztJQUVGLE9BQU8sY0FBUSxDQUFDLEtBQUssQ0FDbkIsY0FBUSxDQUFDLE1BQU0sQ0FBQztRQUNkLEdBQUcsTUFBTTtRQUNULHFCQUFxQixDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsWUFBWSxDQUFDO1lBQy9DLENBQUMsQ0FBQyxjQUFRLENBQUMsUUFBUTtZQUNuQixDQUFDLENBQUMsRUFBRTtLQUNQLENBQUMsRUFDRjtRQUNFLFdBQVcsRUFBRSxZQUFZLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDO0tBQ3RFLENBQ0YsQ0FBQztBQUNKLENBQUM7QUFFRCxTQUFTLFVBQVUsQ0FBQyxJQUFjO0lBQ2hDLE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM3QyxPQUFPLGVBQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxNQUFNLENBQUMsR0FBRyxLQUFLLElBQUksQ0FBQztBQUNoRCxDQUFDO0FBRUQsU0FBUyxZQUFZLENBQUMsSUFBYztJQUNsQyxNQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUcsbUJBQW1CLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDN0MsT0FBTyxlQUFPLENBQUMsTUFBTSxDQUFDLElBQUksTUFBTSxDQUFDLEtBQUssS0FBSyxJQUFJLENBQUM7QUFDbEQsQ0FBQztBQUVELFNBQVMsY0FBYyxDQUNyQixTQUFpQixFQUNqQixTQUFrQixFQUNsQixZQUEwRTtJQUN4RSxLQUFLLEVBQUUsRUFBRTtJQUNULEdBQUcsRUFBRSxFQUFFO0NBQ1I7SUFFRCxNQUFNLEtBQUssR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQ25DLE1BQU0sV0FBVyxHQUFHLFNBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFN0MsTUFBTSxPQUFPLEdBQUcsV0FBVztRQUN6QixDQUFDLENBQUMsU0FBUzthQUNOLElBQUksRUFBRTthQUNOLEtBQUssQ0FBQyxJQUFJLENBQUM7YUFDWCxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFFLENBQ3RCLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDO1lBQ3RDLENBQUMsQ0FBQyxjQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxFQUFFLGNBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNuRCxDQUFDLENBQUMsY0FBUSxDQUFDLE1BQU0sQ0FBQyxjQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxFQUFFLGNBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQ3ZFO1FBQ0wsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7SUFFdkIsT0FBTyxjQUFRLENBQUMsS0FBSyxDQUNuQixjQUFRLENBQUMsTUFBTSxDQUFDO1FBQ2QsSUFBSTtRQUNKLFNBQVMsQ0FBQyxLQUFLO1FBQ2YsS0FBSztRQUNMLEdBQUcsT0FBTztRQUNWLFdBQVcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLO1FBQ3hCLFNBQVMsQ0FBQyxHQUFHO1FBQ2IsSUFBSTtLQUNMLENBQUMsRUFDRixFQUFFLFdBQVcsRUFBRSxDQUNoQixDQUFDO0FBQ0osQ0FBQztBQUVELFNBQVMscUJBQXFCLENBQUMsSUFBWTtJQUN6QyxJQUFJLGNBQU0sQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUNoQixPQUFPLEtBQUssQ0FBQztLQUNkO0lBRUQsTUFBTSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUVwRCxNQUFNLEtBQUssR0FBRyxJQUFJLE1BQU0sQ0FDdEIsaURBQWlELEtBQUssQ0FBQyxFQUFFLEVBQUUsQ0FDNUQsQ0FBQztJQUVGLE9BQU8sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQzlDLENBQUM7QUFFRCxTQUFTLHFCQUFxQixDQUFDLElBQVk7SUFDekMsT0FBTyxJQUFJLENBQUMsSUFBSSxLQUFLLE9BQU8sSUFBSSxJQUFJLENBQUMsT0FBTyxLQUFLLHVCQUF1QixDQUFDO0FBQzNFLENBQUM7QUFFRCxTQUFTLGdCQUFnQixDQUFDLElBQWMsRUFBRSxNQUFjO0lBQ3RELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUN2QyxNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztJQUN4QyxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztJQUU1QyxPQUFPLENBQUMsTUFBTSxDQUFDO0FBQ2pCLENBQUM7QUFFRCxTQUFTLHFCQUFxQixDQUFDLElBQWMsRUFBRSxNQUFjO0lBQzNELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUN2QyxNQUFNLGNBQWMsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNuRCxNQUFNLGVBQWUsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxjQUFjLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDakUsTUFBTSxTQUFTLEdBQUcsTUFBTTtTQUNyQixTQUFTLENBQUMsY0FBYyxHQUFHLENBQUMsRUFBRSxlQUFlLENBQUM7U0FDOUMsSUFBSSxFQUFFLENBQUM7SUFDVixNQUFNLFVBQVUsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7SUFFNUQsT0FBTyxDQUNMLGNBQWMsS0FBSyxDQUFDLENBQUMsSUFBSSxlQUFlLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLElBQUksQ0FBQyxVQUFVLENBQzdFLENBQUM7QUFDSixDQUFDO0FBRUQsU0FBUyxtQkFBbUIsQ0FBQyxJQUE2QjtJQUl4RCxJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUM7SUFDcEIsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUUxQixPQUFPLENBQUMsZUFBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsY0FBTSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQzVDLFFBQVEsR0FBRyxPQUFPLENBQUM7UUFDbkIsT0FBTyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7S0FDMUI7SUFFRCxPQUFPO1FBQ0wsS0FBSyxFQUFFLFFBQVE7UUFDZixNQUFNLEVBQUUsT0FBTztLQUNoQixDQUFDO0FBQ0osQ0FBQztBQUVELFNBQVMsZUFBZSxDQUFDLElBQVksRUFBRSxTQUFTLEdBQUcsSUFBSTtJQUNyRCxNQUFNLFdBQVcsR0FBRyxDQUFDLEtBQWEsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7SUFFOUQsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUUvQixNQUFNLFFBQVEsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUMzQixDQUFDLEtBQUssRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUN4RSxDQUFDO0lBRUYsT0FBTyxjQUFRLENBQUMsTUFBTSxDQUFDO1FBQ3JCLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUM3QixjQUFRLENBQUMsTUFBTSxDQUFDO1lBQ2QsU0FBUyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsY0FBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRTtZQUN2QyxjQUFRLENBQUMsSUFBSTtZQUNiLE9BQU87U0FDUixDQUFDLENBQ0g7UUFDRCxTQUFTLENBQUMsQ0FBQyxDQUFDLGNBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQUU7S0FDbkMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIGRvYyxcbiAgRmFzdFBhdGgsXG4gIFBhcnNlcixcbiAgUGFyc2VyT3B0aW9ucyxcbiAgUHJpbnRlcixcbiAgU3VwcG9ydExhbmd1YWdlLFxufSBmcm9tIFwicHJldHRpZXJcIjtcbmltcG9ydCB7IGJ1aWxkZXJzLCB1dGlscyB9IGZyb20gXCJwcmV0dGllci9kb2NcIjtcbmltcG9ydCB7IHBhcnNlcnMgYXMgaHRtbFBhcnNlcnMgfSBmcm9tIFwicHJldHRpZXIvcGFyc2VyLWh0bWxcIjtcbmltcG9ydCB7XG4gIEdvQmxvY2ssXG4gIEdvSW5saW5lLFxuICBHb0lubGluZUVuZERlbGltaXRlcixcbiAgR29JbmxpbmVTdGFydERlbGltaXRlcixcbiAgR29NdWx0aUJsb2NrLFxuICBHb05vZGUsXG4gIEdvUm9vdCxcbiAgaXNCbG9jayxcbiAgaXNNdWx0aUJsb2NrLFxuICBpc1Jvb3QsXG4gIHBhcnNlR29UZW1wbGF0ZSxcbn0gZnJvbSBcIi4vcGFyc2VcIjtcblxuY29uc3QgaHRtbFBhcnNlciA9IGh0bWxQYXJzZXJzLmh0bWw7XG5jb25zdCBQTFVHSU5fS0VZID0gXCJnby10ZW1wbGF0ZVwiO1xuXG50eXBlIEV4dGVuZGVkUGFyc2VyT3B0aW9ucyA9IFBhcnNlck9wdGlvbnM8R29Ob2RlPiAmXG4gIFByZXR0aWVyUGx1Z2luR29UZW1wbGF0ZVBhcnNlck9wdGlvbnM7XG5cbmV4cG9ydCB0eXBlIFByZXR0aWVyUGx1Z2luR29UZW1wbGF0ZVBhcnNlck9wdGlvbnMgPSB7XG4gIGdvVGVtcGxhdGVCcmFja2V0U3BhY2luZzogYm9vbGVhbjtcbn07XG5cbmV4cG9ydCBjb25zdCBvcHRpb25zOiB7XG4gIFtLIGluIGtleW9mIFByZXR0aWVyUGx1Z2luR29UZW1wbGF0ZVBhcnNlck9wdGlvbnNdOiBhbnk7XG59ID0ge1xuICBnb1RlbXBsYXRlQnJhY2tldFNwYWNpbmc6IHtcbiAgICB0eXBlOiBcImJvb2xlYW5cIixcbiAgICBjYXRlZ29yeTogXCJHbG9iYWxcIixcbiAgICBkZXNjcmlwdGlvbjpcbiAgICAgIFwiU3BlY2lmaWVzIHdoZXRoZXIgdGhlIGJyYWNrZXRzIHNob3VsZCBoYXZlIHNwYWNpbmcgYXJvdW5kIHRoZSBzdGF0ZW1lbnQuXCIsXG4gICAgZGVmYXVsdDogdHJ1ZSxcbiAgfSxcbn07XG5cbmV4cG9ydCBjb25zdCBsYW5ndWFnZXM6IFN1cHBvcnRMYW5ndWFnZVtdID0gW1xuICB7XG4gICAgbmFtZTogXCJHb1RlbXBsYXRlXCIsXG4gICAgcGFyc2VyczogW1BMVUdJTl9LRVldLFxuICAgIGV4dGVuc2lvbnM6IFtcbiAgICAgIFwiLmdvLmh0bWxcIixcbiAgICAgIFwiLmdvaHRtbFwiLFxuICAgICAgXCIuZ290bXBsXCIsXG4gICAgICBcIi5nby50bXBsXCIsXG4gICAgICBcIi50bXBsXCIsXG4gICAgICBcIi50cGxcIixcbiAgICAgIFwiLmh0bWwudG1wbFwiLFxuICAgICAgXCIuaHRtbC50cGxcIixcbiAgICBdLFxuICAgIHZzY29kZUxhbmd1YWdlSWRzOiBbXCJnb3RlbXBsYXRlXCIsIFwiZ29odG1sXCIsIFwiR29UZW1wbGF0ZVwiLCBcIkdvSFRNTFwiXSxcbiAgfSxcbl07XG5leHBvcnQgY29uc3QgcGFyc2VycyA9IHtcbiAgW1BMVUdJTl9LRVldOiA8UGFyc2VyPEdvTm9kZT4+e1xuICAgIC4uLmh0bWxQYXJzZXIsXG4gICAgYXN0Rm9ybWF0OiBQTFVHSU5fS0VZLFxuICAgIHByZXByb2Nlc3M6ICh0ZXh0KSA9PiB0ZXh0LFxuICAgIHBhcnNlOiBwYXJzZUdvVGVtcGxhdGUsXG4gICAgbG9jU3RhcnQ6IChub2RlKSA9PiBub2RlLmluZGV4LFxuICAgIGxvY0VuZDogKG5vZGUpID0+IG5vZGUuaW5kZXggKyBub2RlLmxlbmd0aCxcbiAgfSxcbn07XG5leHBvcnQgY29uc3QgcHJpbnRlcnMgPSB7XG4gIFtQTFVHSU5fS0VZXTogPFByaW50ZXI8R29Ob2RlPj57XG4gICAgcHJpbnQ6IChwYXRoLCBvcHRpb25zOiBFeHRlbmRlZFBhcnNlck9wdGlvbnMsIHByaW50KSA9PiB7XG4gICAgICBjb25zdCBub2RlID0gcGF0aC5nZXROb2RlKCk7XG5cbiAgICAgIHN3aXRjaCAobm9kZT8udHlwZSkge1xuICAgICAgICBjYXNlIFwiaW5saW5lXCI6XG4gICAgICAgICAgcmV0dXJuIHByaW50SW5saW5lKG5vZGUsIHBhdGgsIG9wdGlvbnMsIHByaW50KTtcbiAgICAgICAgY2FzZSBcImRvdWJsZS1ibG9ja1wiOlxuICAgICAgICAgIHJldHVybiBwcmludE11bHRpQmxvY2sobm9kZSwgcGF0aCwgcHJpbnQpO1xuICAgICAgICBjYXNlIFwidW5mb3JtYXR0YWJsZVwiOlxuICAgICAgICAgIHJldHVybiBwcmludFBsYWluQmxvY2sobm9kZS5jb250ZW50LCBmYWxzZSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICAgIGBBbiBlcnJvciBvY2N1cmVkIGR1cmluZyBwcmludGluZy4gRm91bmQgaW52YWxpZCBub2RlICR7bm9kZT8udHlwZX1gXG4gICAgICApO1xuXG4gICAgICByZXR1cm4gb3B0aW9ucy5vcmlnaW5hbFRleHQ7XG4gICAgfSxcbiAgICBlbWJlZDogKHBhdGgsIHByaW50LCB0ZXh0VG9Eb2MsIG9wdGlvbnMpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHJldHVybiBlbWJlZChwYXRoLCBwcmludCwgdGV4dFRvRG9jLCBvcHRpb25zKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihcIkZvcm1hdHRpbmcgZmFpbGVkLlwiLCBlKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIG9wdGlvbnMub3JpZ2luYWxUZXh0O1xuICAgIH0sXG4gIH0sXG59O1xuXG5jb25zdCBlbWJlZDogRXhjbHVkZTxQcmludGVyPEdvTm9kZT5bXCJlbWJlZFwiXSwgdW5kZWZpbmVkPiA9IChcbiAgcGF0aCxcbiAgcHJpbnQsXG4gIHRleHRUb0RvYyxcbiAgb3B0aW9uc1xuKSA9PiB7XG4gIGNvbnN0IG5vZGUgPSBwYXRoLmdldE5vZGUoKTtcblxuICBpZiAoIW5vZGUpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGlmIChoYXNQcmV0dGllcklnbm9yZUxpbmUobm9kZSkpIHtcbiAgICByZXR1cm4gb3B0aW9ucy5vcmlnaW5hbFRleHQuc3Vic3RyaW5nKFxuICAgICAgb3B0aW9ucy5sb2NTdGFydChub2RlKSxcbiAgICAgIG9wdGlvbnMubG9jRW5kKG5vZGUpXG4gICAgKTtcbiAgfVxuXG4gIGlmIChub2RlLnR5cGUgIT09IFwiYmxvY2tcIiAmJiBub2RlLnR5cGUgIT09IFwicm9vdFwiKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBjb25zdCBodG1sID0gdGV4dFRvRG9jKG5vZGUuYWxpYXNlZENvbnRlbnQsIHtcbiAgICAuLi5vcHRpb25zLFxuICAgIHBhcnNlcjogXCJodG1sXCIsXG4gICAgcGFyZW50UGFyc2VyOiBcImdvLXRlbXBsYXRlXCIsXG4gIH0pO1xuXG4gIGNvbnN0IG1hcHBlZCA9IGRvYy51dGlscy5tYXBEb2MoaHRtbCwgKGN1cnJlbnREb2MpID0+IHtcbiAgICBpZiAodHlwZW9mIGN1cnJlbnREb2MgIT09IFwic3RyaW5nXCIpIHtcbiAgICAgIHJldHVybiBjdXJyZW50RG9jO1xuICAgIH1cblxuICAgIGxldCByZXN1bHQ6IGJ1aWxkZXJzLkRvYyA9IGN1cnJlbnREb2M7XG5cbiAgICBPYmplY3Qua2V5cyhub2RlLmNoaWxkcmVuKS5mb3JFYWNoKFxuICAgICAgKGtleSkgPT5cbiAgICAgICAgKHJlc3VsdCA9IGRvYy51dGlscy5tYXBEb2MocmVzdWx0LCAoZG9jTm9kZSkgPT5cbiAgICAgICAgICB0eXBlb2YgZG9jTm9kZSAhPT0gXCJzdHJpbmdcIiB8fCAhZG9jTm9kZS5pbmNsdWRlcyhrZXkpXG4gICAgICAgICAgICA/IGRvY05vZGVcbiAgICAgICAgICAgIDogYnVpbGRlcnMuY29uY2F0KFtcbiAgICAgICAgICAgICAgICBkb2NOb2RlLnN1YnN0cmluZygwLCBkb2NOb2RlLmluZGV4T2Yoa2V5KSksXG4gICAgICAgICAgICAgICAgcGF0aC5jYWxsKHByaW50LCBcImNoaWxkcmVuXCIsIGtleSksXG4gICAgICAgICAgICAgICAgZG9jTm9kZS5zdWJzdHJpbmcoZG9jTm9kZS5pbmRleE9mKGtleSkgKyBrZXkubGVuZ3RoKSxcbiAgICAgICAgICAgICAgXSlcbiAgICAgICAgKSlcbiAgICApO1xuXG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfSk7XG5cbiAgaWYgKG5vZGUudHlwZSA9PT0gXCJyb290XCIpIHtcbiAgICByZXR1cm4gbWFwcGVkO1xuICB9XG5cbiAgaWYgKEFycmF5LmlzQXJyYXkobWFwcGVkKSkge1xuICAgIG1hcHBlZC5wb3AoKTtcbiAgfVxuXG4gIGNvbnN0IHN0YXJ0U3RhdGVtZW50ID0gcGF0aC5jYWxsKHByaW50LCBcInN0YXJ0XCIpO1xuICBjb25zdCBlbmRTdGF0ZW1lbnQgPSBub2RlLmVuZCA/IHBhdGguY2FsbChwcmludCwgXCJlbmRcIikgOiBcIlwiO1xuXG4gIGlmIChpc1ByZXR0aWVySWdub3JlQmxvY2sobm9kZSkpIHtcbiAgICByZXR1cm4gYnVpbGRlcnMuY29uY2F0KFtcbiAgICAgIHV0aWxzLnJlbW92ZUxpbmVzKHBhdGguY2FsbChwcmludCwgXCJzdGFydFwiKSksXG4gICAgICBwcmludFBsYWluQmxvY2sobm9kZS5jb250ZW50KSxcbiAgICAgIGVuZFN0YXRlbWVudCxcbiAgICBdKTtcbiAgfVxuXG4gIGNvbnN0IGNvbnRlbnQgPSBub2RlLmFsaWFzZWRDb250ZW50LnRyaW0oKVxuICAgID8gYnVpbGRlcnMuaW5kZW50KGJ1aWxkZXJzLmNvbmNhdChbYnVpbGRlcnMuc29mdGxpbmUsIG1hcHBlZF0pKVxuICAgIDogXCJcIjtcblxuICBjb25zdCByZXN1bHQgPSBidWlsZGVycy5jb25jYXQoW1xuICAgIHN0YXJ0U3RhdGVtZW50LFxuICAgIGNvbnRlbnQsXG4gICAgYnVpbGRlcnMuc29mdGxpbmUsXG4gICAgZW5kU3RhdGVtZW50LFxuICBdKTtcblxuICBjb25zdCBlbXB0eUxpbmUgPVxuICAgICEhbm9kZS5lbmQgJiYgaXNGb2xsb3dlZEJ5RW1wdHlMaW5lKG5vZGUuZW5kLCBvcHRpb25zLm9yaWdpbmFsVGV4dClcbiAgICAgID8gYnVpbGRlcnMuc29mdGxpbmVcbiAgICAgIDogXCJcIjtcblxuICBpZiAoaXNNdWx0aUJsb2NrKG5vZGUucGFyZW50KSkge1xuICAgIHJldHVybiBidWlsZGVycy5jb25jYXQoW3Jlc3VsdCwgZW1wdHlMaW5lXSk7XG4gIH1cblxuICByZXR1cm4gYnVpbGRlcnMuZ3JvdXAoYnVpbGRlcnMuY29uY2F0KFtidWlsZGVycy5ncm91cChyZXN1bHQpLCBlbXB0eUxpbmVdKSwge1xuICAgIHNob3VsZEJyZWFrOiAhIW5vZGUuZW5kICYmIGhhc05vZGVMaW5lYnJlYWsobm9kZS5lbmQsIG9wdGlvbnMub3JpZ2luYWxUZXh0KSxcbiAgfSk7XG59O1xuXG50eXBlIFByaW50Rm4gPSAocGF0aDogRmFzdFBhdGg8R29Ob2RlPikgPT4gYnVpbGRlcnMuRG9jO1xuXG5mdW5jdGlvbiBwcmludE11bHRpQmxvY2soXG4gIG5vZGU6IEdvTXVsdGlCbG9jayxcbiAgcGF0aDogRmFzdFBhdGg8R29Ob2RlPixcbiAgcHJpbnQ6IFByaW50Rm5cbik6IGJ1aWxkZXJzLkRvYyB7XG4gIHJldHVybiBidWlsZGVycy5jb25jYXQoWy4uLnBhdGgubWFwKHByaW50LCBcImJsb2Nrc1wiKV0pO1xufVxuXG5mdW5jdGlvbiBwcmludElubGluZShcbiAgbm9kZTogR29JbmxpbmUsXG4gIHBhdGg6IEZhc3RQYXRoPEdvTm9kZT4sXG4gIG9wdGlvbnM6IEV4dGVuZGVkUGFyc2VyT3B0aW9ucyxcbiAgcHJpbnQ6IFByaW50Rm5cbik6IGJ1aWxkZXJzLkRvYyB7XG4gIGNvbnN0IGhhc0xpbmVCcmVhayA9IGhhc05vZGVMaW5lYnJlYWsobm9kZSwgb3B0aW9ucy5vcmlnaW5hbFRleHQpO1xuXG4gIGNvbnN0IHJlc3VsdDogYnVpbGRlcnMuRG9jW10gPSBbXG4gICAgcHJpbnRTdGF0ZW1lbnQobm9kZS5zdGF0ZW1lbnQsIG9wdGlvbnMuZ29UZW1wbGF0ZUJyYWNrZXRTcGFjaW5nLCB7XG4gICAgICBzdGFydDogbm9kZS5zdGFydERlbGltaXRlcixcbiAgICAgIGVuZDogbm9kZS5lbmREZWxpbWl0ZXIsXG4gICAgfSksXG4gIF07XG5cbiAgcmV0dXJuIGJ1aWxkZXJzLmdyb3VwKFxuICAgIGJ1aWxkZXJzLmNvbmNhdChbXG4gICAgICAuLi5yZXN1bHQsXG4gICAgICBpc0ZvbGxvd2VkQnlFbXB0eUxpbmUobm9kZSwgb3B0aW9ucy5vcmlnaW5hbFRleHQpXG4gICAgICAgID8gYnVpbGRlcnMuc29mdGxpbmVcbiAgICAgICAgOiBcIlwiLFxuICAgIF0pLFxuICAgIHtcbiAgICAgIHNob3VsZEJyZWFrOiBoYXNMaW5lQnJlYWsgJiYgIWlzQmxvY2tFbmQobm9kZSkgJiYgIWlzQmxvY2tTdGFydChub2RlKSxcbiAgICB9XG4gICk7XG59XG5cbmZ1bmN0aW9uIGlzQmxvY2tFbmQobm9kZTogR29JbmxpbmUpIHtcbiAgY29uc3QgeyBwYXJlbnQgfSA9IGdldEZpcnN0QmxvY2tQYXJlbnQobm9kZSk7XG4gIHJldHVybiBpc0Jsb2NrKHBhcmVudCkgJiYgcGFyZW50LmVuZCA9PT0gbm9kZTtcbn1cblxuZnVuY3Rpb24gaXNCbG9ja1N0YXJ0KG5vZGU6IEdvSW5saW5lKSB7XG4gIGNvbnN0IHsgcGFyZW50IH0gPSBnZXRGaXJzdEJsb2NrUGFyZW50KG5vZGUpO1xuICByZXR1cm4gaXNCbG9jayhwYXJlbnQpICYmIHBhcmVudC5zdGFydCA9PT0gbm9kZTtcbn1cblxuZnVuY3Rpb24gcHJpbnRTdGF0ZW1lbnQoXG4gIHN0YXRlbWVudDogc3RyaW5nLFxuICBhZGRTcGFjZXM6IGJvb2xlYW4sXG4gIGRlbGltaXRlcjogeyBzdGFydDogR29JbmxpbmVTdGFydERlbGltaXRlcjsgZW5kOiBHb0lubGluZUVuZERlbGltaXRlciB9ID0ge1xuICAgIHN0YXJ0OiBcIlwiLFxuICAgIGVuZDogXCJcIixcbiAgfVxuKSB7XG4gIGNvbnN0IHNwYWNlID0gYWRkU3BhY2VzID8gXCIgXCIgOiBcIlwiO1xuICBjb25zdCBzaG91bGRCcmVhayA9IHN0YXRlbWVudC5pbmNsdWRlcyhcIlxcblwiKTtcblxuICBjb25zdCBjb250ZW50ID0gc2hvdWxkQnJlYWtcbiAgICA/IHN0YXRlbWVudFxuICAgICAgICAudHJpbSgpXG4gICAgICAgIC5zcGxpdChcIlxcblwiKVxuICAgICAgICAubWFwKChsaW5lLCBfLCBhcnJheSkgPT5cbiAgICAgICAgICBhcnJheS5pbmRleE9mKGxpbmUpID09PSBhcnJheS5sZW5ndGggLSAxXG4gICAgICAgICAgICA/IGJ1aWxkZXJzLmNvbmNhdChbbGluZS50cmltKCksIGJ1aWxkZXJzLnNvZnRsaW5lXSlcbiAgICAgICAgICAgIDogYnVpbGRlcnMuaW5kZW50KGJ1aWxkZXJzLmNvbmNhdChbbGluZS50cmltKCksIGJ1aWxkZXJzLnNvZnRsaW5lXSkpXG4gICAgICAgIClcbiAgICA6IFtzdGF0ZW1lbnQudHJpbSgpXTtcblxuICByZXR1cm4gYnVpbGRlcnMuZ3JvdXAoXG4gICAgYnVpbGRlcnMuY29uY2F0KFtcbiAgICAgIFwie3tcIixcbiAgICAgIGRlbGltaXRlci5zdGFydCxcbiAgICAgIHNwYWNlLFxuICAgICAgLi4uY29udGVudCxcbiAgICAgIHNob3VsZEJyZWFrID8gXCJcIiA6IHNwYWNlLFxuICAgICAgZGVsaW1pdGVyLmVuZCxcbiAgICAgIFwifX1cIixcbiAgICBdKSxcbiAgICB7IHNob3VsZEJyZWFrIH1cbiAgKTtcbn1cblxuZnVuY3Rpb24gaGFzUHJldHRpZXJJZ25vcmVMaW5lKG5vZGU6IEdvTm9kZSkge1xuICBpZiAoaXNSb290KG5vZGUpKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgY29uc3QgeyBwYXJlbnQsIGNoaWxkIH0gPSBnZXRGaXJzdEJsb2NrUGFyZW50KG5vZGUpO1xuXG4gIGNvbnN0IHJlZ2V4ID0gbmV3IFJlZ0V4cChcbiAgICBgKD86PCEtLXx7eykuKj9wcmV0dGllci1pZ25vcmUuKj8oPzotLT58fX0pXFxuLioke2NoaWxkLmlkfWBcbiAgKTtcblxuICByZXR1cm4gISFwYXJlbnQuYWxpYXNlZENvbnRlbnQubWF0Y2gocmVnZXgpO1xufVxuXG5mdW5jdGlvbiBpc1ByZXR0aWVySWdub3JlQmxvY2sobm9kZTogR29Ob2RlKSB7XG4gIHJldHVybiBub2RlLnR5cGUgPT09IFwiYmxvY2tcIiAmJiBub2RlLmtleXdvcmQgPT09IFwicHJldHRpZXItaWdub3JlLXN0YXJ0XCI7XG59XG5cbmZ1bmN0aW9uIGhhc05vZGVMaW5lYnJlYWsobm9kZTogR29JbmxpbmUsIHNvdXJjZTogc3RyaW5nKSB7XG4gIGNvbnN0IHN0YXJ0ID0gbm9kZS5pbmRleCArIG5vZGUubGVuZ3RoO1xuICBjb25zdCBlbmQgPSBzb3VyY2UuaW5kZXhPZihcIlxcblwiLCBzdGFydCk7XG4gIGNvbnN0IHN1ZmZpeCA9IHNvdXJjZS5zdWJzdHJpbmcoc3RhcnQsIGVuZCk7XG5cbiAgcmV0dXJuICFzdWZmaXg7XG59XG5cbmZ1bmN0aW9uIGlzRm9sbG93ZWRCeUVtcHR5TGluZShub2RlOiBHb0lubGluZSwgc291cmNlOiBzdHJpbmcpIHtcbiAgY29uc3Qgc3RhcnQgPSBub2RlLmluZGV4ICsgbm9kZS5sZW5ndGg7XG4gIGNvbnN0IGZpcnN0TGluZUJyZWFrID0gc291cmNlLmluZGV4T2YoXCJcXG5cIiwgc3RhcnQpO1xuICBjb25zdCBzZWNvbmRMaW5lQnJlYWsgPSBzb3VyY2UuaW5kZXhPZihcIlxcblwiLCBmaXJzdExpbmVCcmVhayArIDEpO1xuICBjb25zdCBlbXB0eUxpbmUgPSBzb3VyY2VcbiAgICAuc3Vic3RyaW5nKGZpcnN0TGluZUJyZWFrICsgMSwgc2Vjb25kTGluZUJyZWFrKVxuICAgIC50cmltKCk7XG4gIGNvbnN0IGlzTGFzdE5vZGUgPSAhIXNvdXJjZS5zdWJzdHJpbmcoc3RhcnQpLm1hdGNoKC9eXFxzKiQvKTtcblxuICByZXR1cm4gKFxuICAgIGZpcnN0TGluZUJyZWFrICE9PSAtMSAmJiBzZWNvbmRMaW5lQnJlYWsgIT09IC0xICYmICFlbXB0eUxpbmUgJiYgIWlzTGFzdE5vZGVcbiAgKTtcbn1cblxuZnVuY3Rpb24gZ2V0Rmlyc3RCbG9ja1BhcmVudChub2RlOiBFeGNsdWRlPEdvTm9kZSwgR29Sb290Pik6IHtcbiAgcGFyZW50OiBHb0Jsb2NrIHwgR29Sb290O1xuICBjaGlsZDogdHlwZW9mIG5vZGU7XG59IHtcbiAgbGV0IHByZXZpb3VzID0gbm9kZTtcbiAgbGV0IGN1cnJlbnQgPSBub2RlLnBhcmVudDtcblxuICB3aGlsZSAoIWlzQmxvY2soY3VycmVudCkgJiYgIWlzUm9vdChjdXJyZW50KSkge1xuICAgIHByZXZpb3VzID0gY3VycmVudDtcbiAgICBjdXJyZW50ID0gY3VycmVudC5wYXJlbnQ7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIGNoaWxkOiBwcmV2aW91cyxcbiAgICBwYXJlbnQ6IGN1cnJlbnQsXG4gIH07XG59XG5cbmZ1bmN0aW9uIHByaW50UGxhaW5CbG9jayh0ZXh0OiBzdHJpbmcsIGhhcmRsaW5lcyA9IHRydWUpOiBidWlsZGVycy5Eb2Mge1xuICBjb25zdCBpc1RleHRFbXB0eSA9IChpbnB1dDogc3RyaW5nKSA9PiAhIWlucHV0Lm1hdGNoKC9eXFxzKiQvKTtcblxuICBjb25zdCBsaW5lcyA9IHRleHQuc3BsaXQoXCJcXG5cIik7XG5cbiAgY29uc3Qgc2VnbWVudHMgPSBsaW5lcy5maWx0ZXIoXG4gICAgKHZhbHVlLCBpKSA9PiAhKGkgPT0gMCB8fCBpID09IGxpbmVzLmxlbmd0aCAtIDEpIHx8ICFpc1RleHRFbXB0eSh2YWx1ZSlcbiAgKTtcblxuICByZXR1cm4gYnVpbGRlcnMuY29uY2F0KFtcbiAgICAuLi5zZWdtZW50cy5tYXAoKGNvbnRlbnQsIGkpID0+XG4gICAgICBidWlsZGVycy5jb25jYXQoW1xuICAgICAgICBoYXJkbGluZXMgfHwgaSA/IGJ1aWxkZXJzLmhhcmRsaW5lIDogXCJcIixcbiAgICAgICAgYnVpbGRlcnMudHJpbSxcbiAgICAgICAgY29udGVudCxcbiAgICAgIF0pXG4gICAgKSxcbiAgICBoYXJkbGluZXMgPyBidWlsZGVycy5oYXJkbGluZSA6IFwiXCIsXG4gIF0pO1xufVxuIl19